services:
  postgres:
    image: postgres:18-alpine
    container_name: dashboard-postgres-superset
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-superset}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-superset}
      POSTGRES_DB: ${POSTGRES_DB:-superset}
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - dashboard
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U superset -d superset"]
      interval: 30s
      timeout: 10s
      retries: 5

  valkey:
    image: valkey/valkey:latest
    container_name: dashboard-valkey
    restart: always
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
    volumes:
      - valkey_data:/data
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5

  trino:
    image: trinodb/trino:latest
    container_name: dashboard-trino
    ports:
      - "8080:8080"
    volumes:
      - ./config/r2.properties:/etc/trino/catalog/r2.properties:ro
    env_file:
      - .env
    restart: unless-stopped
    networks:
      - dashboard

  superset:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dashboard-superset
    user: "superset"
    ports:
      - "8088:8088"
    environment:
      SUPERSET_SECRET_KEY: ${SUPERSET_SECRET_KEY}
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_DB: ${POSTGRES_DB:-superset}
      DATABASE_USER: ${DATABASE_USER:-superset}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      SUPERSET_ADMIN_USERNAME: ${SUPERSET_ADMIN_USERNAME:-admin}
      SUPERSET_ADMIN_PASSWORD: ${SUPERSET_ADMIN_PASSWORD}
      SUPERSET_ADMIN_EMAIL: ${SUPERSET_ADMIN_EMAIL:-admin@localhost}
    volumes:
      - superset_data:/app/superset_home
      - ./config/superset_config.py:/app/pythonpath/superset_config.py:ro
      - ./config/superset_init.sh:/app/docker-init.sh:ro
    depends_on:
      postgres:
        condition: service_healthy
      valkey:
        condition: service_healthy
      trino:
        condition: service_started
    restart: unless-stopped
    networks:
      - dashboard
    command: >
      sh -c "
        /app/docker-init.sh
        superset run -h 0.0.0.0 -p 8088 --with-threads
      "
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 1m
      timeout: 15s
      retries: 5
      start_period: 120s
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

networks:
  dashboard:
    driver: bridge

volumes:
  postgres_data:
  valkey_data:
  superset_data:
